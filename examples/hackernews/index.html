<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <link href="/src/base.css" rel="stylesheet"/>
    <link href="hackernews.css" rel="stylesheet"/>
    <script type="text/x-template" id="x-front-page">
      <nav>
        <div id="logo">hackernews</div>
        <div id="settings">
          top
          <input id="top-value"
                 .bind:value="$.n"
                 .on:change:no="$.updateStories($, $update)">
          <select id="top-unit"
                  .bind:value="$.unit"
                  .on:change:no="$.updateStories($, $update)">
            <option>n</option>
            <option>%</option>
          </select>
          sorted by
          <select id="top-order"
                  .bind:value="$.order"
                  .on:change:no="$.updateStories($, $update)">
            <option>date</option>
            <option>points</option>
            <option>comments</option>
          </select>
        </div>
      </nav>

      <table id="stories">
        <thead>
          <tr>
            <th class="points">pts</th>
            <th class="comments">cmnts</th>
          </tr>
        </thead>
        <tbody>
          <tr .for="story in $.stories">
            <td class="points" style="--alpha: {($.story.points / $.maxPoints) * 100}%;">
              <p class="{$.isOld($.story) ? 'old' : ''}">{$.story.points || 0}</p>
            </td>
            <td class="comments" style="--alpha: {($.story.num_comments / $.maxComments) * 100}%;">
              <a href="https://news.ycombinator.com/item?id={$.story.objectID}">{$.story.num_comments || 0}</a>
            </td>
            <td class="title">
              <a href="{$.story.url}">{$.story.title} <small>({$.story.hostname})</small></a>
              <div class="author">
                {$.timeSince($.story)} ago by
                <a href="https://news.ycombinator.com/user?id={$.story.author}">{$.story.author}</a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </script>

    <script type="module">
     import {mount, hooks} from "/src/runtime.mjs";

     hooks["x-front-page"] = {
       async create($, properties, {$update}) {
         const defaults = {n: 20, unit: "n", order: "date", seen: {}};
         Object.assign($, defaults, JSON.parse(localStorage.getItem("hackernews") || "{}"));
         await $.updateStories($, $update);
       },
       async update($, properties, {$update}) {
         for (const id in $.seen) if (Date.now() - $.seen[id] > 2 * 24 * 60 * 60 * 1000) delete $.seen[id];
         localStorage.setItem("hackernews", JSON.stringify({
           n: $.n,
           unit: $.unit,
           order: $.order,
           seen: $.seen
         }));
       },
     };

     mount(document.body, "x-front-page", {
       stories: [],

       timeSince(story) {
         const fmt = (n, unit) => `${n} ${unit}${n === 1 ? "" : "s"}`;
         const s = Date.now() / 1000 - story.created_at_i;
         if (s < 60 * 60) return fmt(Math.floor(s / 60), "minute");
         else if (s < 60 * 60 * 24) return fmt(Math.floor(s / 60 / 60), "hour");
         else return fmt(Math.floor(s / 60 / 60 / 24), "day");
       },

       isOld(story) {
         return Date.now() - this.seen[story.objectID] > 60 * 60 * 1000;
       },

       seen(story) {
         const fmt = (n, unit) => `${n} ${unit}${n === 1 ? "" : "s"}`;
         const s = Date.now() / 1000 - story.created_at_i;
         if (s < 60 * 60) return fmt(Math.floor(s / 60), "minute");
         else if (s < 60 * 60 * 24) return fmt(Math.floor(s / 60 / 60), "hour");
         else return fmt(Math.floor(seconds / 60 / 60 / 24), "day");
       },

       async updateStories({n, unit, order}, $update) {
         const url = "https://hn.algolia.com/api/v1/search?tags=front_page&hitsPerPage=50";
         const {hits} = await fetch(url).then(r => r.json());
         const orderProperty = order === "date" ? "created_at_i" :
                               order === "points" ? "points" : "num_comments"
         this.stories = hits
           .sort((a, b) => b.points - a.points)
           .slice(0, unit === "n" ? n : Math.ceil(hits.length * (n / 100)))
           .sort((a, b) => b[orderProperty] - a[orderProperty])
           .map(s => {
             if (!this.seen[s.objectID]) this.seen[s.objectID] = Date.now();
             if (!s.url) s.url = `https://news.ycombinator.com/item?id=${s.objectID}`;
             s.hostname = new URL(s.url).hostname;
             return s
           });
         this.maxPoints = Math.max(...this.stories.map(s => s.points));
         this.maxComments = Math.max(...this.stories.map(s => s.num_comments));
         $update();
       },
     });
    </script>
  </head>
  <body></body>
</html>
