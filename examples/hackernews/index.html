<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <link href="/src/base.css" rel="stylesheet"/>
    <link href="hackernews.css" rel="stylesheet"/>
    <script type="text/x-template" id="x-front-page">
      <nav>
        <div id="logo">hackernews</div>
        <div id="settings">
          top
          <input id="top-value"
                 .bind:value="$.n"
                 .on:change:no="$.updateStories($, $update)">
          <select id="top-unit"
                  .bind:value="$.unit"
                  .on:change:no="$.updateStories($, $update)">
            <option>n</option>
            <option>%</option>
          </select>
          sorted by
          <select id="top-order"
                  .bind:value="$.order"
                  .on:change:no="$.updateStories($, $update)">
            <option>date</option>
            <option>points</option>
            <option>comments</option>
          </select>
        </div>
      </nav>

      <table>
        <thead>
          <tr>
            <th class="points">pts</th>
            <th class="comments">cmnts</th>
          </tr>
        </thead>
        <tbody>
          <tr .for="story in $.stories">
            <td class="points" style="--alpha: {($.story.points / $.maxPoints) * 100}%;">
              <p class="{$.story.created_at_i * 1000 > $.lastVisit || 'old'}">{$.story.points || 0}</p>
            </td>
            <td class="comments" style="--alpha: {($.story.num_comments / $.maxComments) * 100}%;">
              <a href="https://news.ycombinator.com/item?id={$.story.objectID}">{$.story.num_comments || 0}</a>
            </td>
            <td class="title">
              <a href="{$.story.url}">{$.story.title} <small>({$.story.hostname})</small></a>
            </td>
          </tr>
        </tbody>
      </table>
    </script>

    <script type="module">
     import {mount, hooks} from "/src/runtime.mjs";

     hooks["x-front-page"] = {
       async create($, properties, {$update}) {
         const defaults = {n: 20, unit: "n", order: "date", lastVisit: 0};
         Object.assign($, defaults, JSON.parse(localStorage.getItem("hackernews") || "{}"));
         await $.updateStories($, $update);
       },
       async update($, properties, {$update}) {
         localStorage.setItem("hackernews", JSON.stringify({
           n: $.n,
           unit: $.unit,
           lastVisit: Date.now(),
         }));
       },
     };

     mount(document.body, "x-front-page", {
       maxPoints: 0,
       stories: [],
       async updateStories({n, unit, order}, $update) {
         const url = "https://hn.algolia.com/api/v1/search?tags=front_page&hitsPerPage=50";
         const {hits} = await fetch(url).then(r => r.json());
         const orderProperty = order === "date" ? "created_at_i" :
                               order === "points" ? "points" : "num_comments"
         this.stories = hits
           .sort((a, b) => b.points - a.points)
           .slice(0, unit === "n" ? n : Math.ceil(hits.length * (n / 100)))
           .sort((a, b) => b[orderProperty] - a[orderProperty])
           .map(s => {
             try { s.hostname = new URL(s.url).hostname; } catch (_) {}
             return s
           });
         this.maxPoints = Math.max(...this.stories.map(s => s.points));
         this.maxComments = Math.max(...this.stories.map(s => s.num_comments));
         $update();
       },
     });
    </script>
  </head>
  <body></body>
</html>
