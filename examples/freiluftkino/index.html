<!DOCTYPE html>
<html>
  <head>
    <title>freiluftkino</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/src/base.css" rel="stylesheet"/>
    <link href="module.css" rel="stylesheet"/>
    <script type="x-module" src="/modules/app/index.html"></script>
    <script type="x-module" src="list.html"></script>
    <script type="x-module" src="details.html"></script>
    <script type="text/x-template" id="x-nav">
      <div ..links>
        <a href="#/" id="logo">freiluftkino</a>
        <div ..other>
          <a href="#/hidden" ..active="$.app.path === '/hidden'">hidden ({$.hiddenCount})</a> |
          <a href="#/favorites" ..active="$.app.path === '/favorites'">favorites ({$.favoriteCount})</a>
        </div>
      </div>
      <details open="{$.app.path.startsWith('/cinema/')}">
        <summary>cinemas</summary>
        <ul>
          <li .for="[id, name] in $.app.props.cinemas">
            <a ..active="$.app.params?.id === id" href="#/cinema/{id}">{name}</a>
          </li>
        </ul>
      </details>
      <details>
        <summary>filters</summary>
        <div #settings>
          <div>
            <input id="onlyAvailable"
                   type="checkbox"
                   .bind:checked="$.app.db.onlyAvailable"
                   .on:change="$.app.update()">
            <label for="onlyAvailable">only available</label>
          </div>
          <label for="partialTitle">title</label>
          <input id="partialTitle"
                 type="text"
                 placeholder="title"
                 .bind:value="$.app.searchTitle"
                 .on:keyup="$.app.update()">
          <label for="cinema">excluded cinemas</label>
          <select multiple id="cinema"
                  .bind:options="$.app.db.excludedCinemas"
                  .on:change:no="$.app.update()">
            <option .for="[_, name] in $.app.props.cinemas">{name}</option>
          </select>
        </div>
      </details>
    </script>

    <style>
     x-nav {
       display: flex;
       flex-direction: column;
       gap: 0.5em;
       padding: 0.5em;
     }

     x-nav .links{
       display: flex;
       justify-content: space-between;
     }

     x-nav .active {
       text-decoration: underline;
     }

     x-nav #logo {
       font-size: 2em;
     }

     x-nav details summary {
       font-size: 1.5em;
     }

     x-nav #settings {
       display: flex;
       flex-direction: column;
       gap: 0.5em;
     }
    </style>

    <script type="module">
     import {mount, define, Component} from "/src/runtime.mjs";

     define("x-nav", class extends Component {
       onRender() {
         this.favoriteCount = Object.entries(this.app.db.favoriteShows || {}).filter(([id, x]) => x && this.props.shows[id]).length;
         this.hiddenCount = Object.entries(this.app.db.hiddenMovies || {}).filter(([key, x]) => x && Object.values(this.props.shows).find(x => x.key === key)).length;
       }
     });
     (async () => {
       const history = await fetch("https://niklasfasching.github.io/freiluftkino/history.json").then(r => r.json());
       const shows = await fetch("https://niklasfasching.github.io/freiluftkino/shows.json").then(r => r.json());
       for (const id in shows) {
         shows[id].key = shows[id].title.toLowerCase().replace(/\(.*\)|-.*?film preview|open air:/g, "").trim();
       }
       await mount(document.body, "x-app", {
         header: ["x-nav", () => ({shows})],
         routes: {
           "/": ["x-list", () => ({shows, history})],
           "/favorites": ["x-list", () => ({shows, history})],
           "/hidden": ["x-list", () => ({shows, history})],
           "/cinema/{id}": ["x-list", () => ({shows, history})],
           "/show/{id}": ["x-details", (app) => {
             const show = shows[app.params.id];
             return {shows, show, history: history[show?.url]};
           }],
         },
         cinemas: Object.fromEntries(Object.values(shows).map(x => [x.cinemaId, x.cinemaShortName])),
         db: {
           searchTitle: "",
           excludedCinemas: {},
           onlyAvailable: false,
         },
       });
     })();
    </script>
  </head>
</html>
