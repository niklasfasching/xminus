<!DOCTYPE html>
<html>
  <head>
    <title>freiluftkino</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/src/base.css" rel="stylesheet"/>
    <link href="module.css" rel="stylesheet"/>
    <script type="x-module" src="/modules/app/index.html"></script>
    <script type="x-module" src="/modules/chart/index.html"></script>
    <script type="text/x-template" id="x-flk">
      <nav>
        <div id="logo">freiluftkino</div>
        <details>
          <summary>filters</summary>
          <div #settings>
            <div>
              <input id="onlyAvailable"
                     type="checkbox"
                     .bind:checked="$.app.db.onlyAvailable"
                     .on:change="$.app.update()">
              <label for="onlyAvailable">only available</label>
            </div>
            <input id="partialTitle"
                   type="text"
                   placeholder="title"
                   .bind:value="$.app.db.searchTitle"
                   .on:keyup="$.app.update()">
            <select multiple id="cinema"
                    .bind:options="$.app.db.selectedCinemas"
                    .on:change:no="$.app.update()">
              <option .for="value of $.cinemas">{value}</option>
            </select>
          </div>
        </details>
      </nav>
      <div ..days>
        <div ..day .for="[day, shows] in $.shows">
          <div ..date>{day.slice(0, -1)}</div>
          <div ..shows>
            <x-show show={show} .for="show of shows"/>
          </div>
        </div>
      </div>
    </script>

    <script type="text/x-template" id="x-show" x-props="show">
      <div ..cover ..bookable="$.show.bookable">
        <a href="#/show/{$.show.id}">
          <img src="{$.show.img}" loading="lazy">
        </a>
        <div ..time>{$.show.time}</div>
        <div ..seats>
          <span ..tag ..available>{$.show.available || 0}</span>
          <span ..tag ..reserved>{$.show.reserved || 0}</span>
        </div>
        <div ..info>
          <div ..title title="{$.show.title}"><a href="{$.show.url}">{$.show.title}</a></div>
          <a ..cinema href="{$.show.cinemaUrl}">{$.show.cinemaShortName}</a>
        </div>
      </div>
    </script>

    <script type="text/x-template" id="x-details" x-props="show history">
      <img src="{$.show.img}">
      <div ..time>{$.show.date} - {$.show.time}</div>
      <div ..title><a href="{$.show.url}">{$.show.title}</a></div>
      <a ..cinema href="{$.show.cinemaUrl}">{$.show.cinemaShortName}</a>
      <x-chart {...$.chart} formatTooltip="{$.formatTooltip}"></x-chart>
      <div ..tags>
        <span ..tag ..available>{$.show.available || 0}</span>
        <span ..tag ..reserved>{$.show.reserved || 0}</span>
        <a .if="$.show.trailer" ..trailer ..tag href="{$.show.trailer}" target="_blank" rel="noopener">trailer</a>
      </div>
      <div ..description>{$.show.description}</div>
    </script>
    <script type="module">
     import {mount, define, Component} from "/src/runtime.mjs";

     define("x-flk", class extends Component {
       async onInit() {
         this.cinemas = Object.keys(this.props.showsByCinema);
         this.onUpdate();
       }

       onUpdate() {
         const {selectedCinemas, searchTitle, onlyAvailable} = this.app.db;
         this.shows = Object.values(this.props.showsByCinema).flat().sort((a, b) => a.timestamp - b.timestamp)
                            .filter(x => {
                              return x.timestamp >= Date.now() &&
                                     x.title.toLowerCase().includes(searchTitle.toLowerCase()) &&
                                     (!Object.keys(selectedCinemas).length || selectedCinemas[x.cinemaName]) &&
                                     (!onlyAvailable || (x.reserved && x.available))

                            })
                            .reduce((g, s) => {
                              (g[s.date] = g[s.date] || []).push(s);
                              g[s.date] = g[s.date].sort((x, y) => x.time > y.time);
                              return g;
                            }, {});
       }
     });

     define("x-details", class extends Component {
       onRender() {
         this.chart = {
           xMin: this.history[0]?.[0] || 0,
           xMax: Date.now(),
           yMin: 0,
           yMax: Math.max(...this.history.map(([x, y]) => y)),
           values: this.history,
         };
       }

       formatTooltip({vx, vy}) {
         return `${new Date(vx).toLocaleDateString("de").split(".").slice(0, 2).join(".")}. | ${vy.toFixed()} free`;
       }
     });

     (async () => {
       const showsByCinema = await fetch("https://niklasfasching.github.io/freiluftkino/showsByCinema.json").then(r => r.json());
       const showHistory = await fetch("https://niklasfasching.github.io/freiluftkino/showHistory.json").then(r => r.json());
       window.app = await mount(document.body, "x-app", {
         routes: {
           "/": ["x-flk", () => ({showsByCinema, showHistory})],
           "/show/{id}": ["x-details", (app) => {
             const show = Object.values(showsByCinema).flat().find(show => show.id === app.params.id);
             return {
               show,
               history: showHistory[show?.url],
             };
           }],
         },
         db: {
           searchTitle: "",
           selectedCinemas: {},
           onlyAvailable: false,
         },
       });
     })()
    </script>
  </head>
  <style>

  </style>
  <body></body>
</html>
