<!DOCTYPE html>
<head>
  <title>app</title>
  <script type="text/x-template" id="x-app"></script>
  <script type="module">
   import {define, Component} from "/src/runtime.mjs";
   define("x-app", class extends Component {
     onInit({db, routes}) {
       this.db = this.initDB(db);
       if (!location.hash) history.replaceState(null, null, "#/");
       this.routeList = Object.entries(routes || []).map(([path, tag]) => [
         new RegExp("^" + path.replace(/\/?$/, "/?$").replaceAll(/{(\w+)}/g, "(?<$1>[^/]+)")),
         tag,
       ]);
       if (routes) {
         window.addEventListener("hashchange", () => {
           this.route();
           this.update();
         });
         this.route();
       }
     }

     initDB(defaults = {}) {
       const json = localStorage.getItem("app.db");
       const db = Object.assign({}, defaults, json === "" ? {} : JSON.parse(json));
       return this.proxy(db, () => localStorage.setItem("app.db", JSON.stringify(this.db)));
     }

     route() {
       const [path, query] = location.hash.slice(1).split("?");
       const [r, [tag, f = (app) => ({})]] = this.routeList.find(([r]) => r.test(path)) || [null, []];
       if (!r) throw new Error(`404 for ${path}: ${JSON.stringify(this.routes)}`);
       this.path = path;
       this.params = r.exec(path).groups;
       this.query = Object.fromEntries(new URLSearchParams(query).entries());
       this.onUpdate = () => void this.active.update?.(f(this.app));
       if (this.active?.tagName === tag.toUpperCase()) return void this.active.update?.(f(this.app));
       this.active = document.createElement(tag);
       if (this.active instanceof Component) this.active.init(this.app, this, f(this.app));
       if (!this.firstChild) this.append(this.active);
       else this.firstChild.replaceWith(this.active);
     }

     proxy(x, cb) {
       const that = this;
       return new Proxy(x, {
         get(x, key) {
           const value = x[key];
           return typeof value === "object" ? that.proxy(value, cb) : value;
         },
         set(x, key, value) {
           x[key] = value;
           cb();
           return true;
         },
       })
     }
   });
  </script>
</head>

<body x-dev>
  <script type="module">
   import {mount} from "/src/runtime.mjs";
   import {compile} from "/src/compiler.mjs";
   import {t} from "/src/test.mjs";

   eval(compile("x-child", `<element>{$.app.params.param}</element>`))

   t.after("reset hash", () => location.hash = "");

   t("should route", async () => {
     const component = await mount(document.body, "x-app", {routes: {
       "/p": ["p"],
       "/{param}": ["x-child"],
       "/": ["hr"],
     }});
     t.equal(component.active.tagName, "HR");

     location.hash = "/p";
     await new Promise(r => setTimeout(r));
     t.equal(component.active.tagName, "P");

     location.hash = "/whatever";
     await new Promise(r => setTimeout(r));
     t.equal(component.active.tagName, "X-CHILD");
     t.equal(component.innerText, "whatever");
   });

   t("should persist db", async () => {
     localStorage.removeItem("app.db")
     const app = await mount(document.body, "x-app", {
       db: {a: 10},
     });
     t.equal(app.db.a, 10);
     app.db.a = 20;
     t.equal(app.db.a, 20);
     t.equal(localStorage.getItem("app.db"), `{"a":20}`);
     app.db.b = 20;
     t.equal(app.db.b, 20);
     app.db.c = {d: 10};
     t.equal(app.db.c.d, 10);
     app.db.c.d = 20;
     t.equal(app.db.c.d, 20);
     app.db.d = [1, 2];
     t.jsonEqual(app.db.d, [1, 2]);
     app.db.d[1] = 3;
     t.jsonEqual(app.db.d, [1, 3]);
     t.equal(localStorage.getItem("app.db"), `{"a":20,"b":20,"c":{"d":20},"d":[1,3]}`);
   });
  </script>
</body>
