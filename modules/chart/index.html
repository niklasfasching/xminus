<!DOCTYPE html>
<html>
  <head>
    <title>chart</title>
    <meta name="viewport" content="width=device-width">
    <link rel="manifest" href="manifest.json">
    <script type="text/x-template" id="x-chart">
      <svg class="chart" viewBox="0 0 100 100" role="img" preserveAspectRatio="none">
        <g .for="b of $.bars">
          <rect width="{b.width}" height="{b.height}" x="{b.x}" y="{b.y}"></rect>
        </g>
      </svg>

    </script>

    <script type="module">
     import {mount, define, Component} from "/src/runtime.mjs";
     define("x-chart", class extends Component {
       onInit() {
         this.onUpdate();
       }

       onUpdate() {
         const {values, xMin, xMax, yMin, yMax} = this.props;
         this.bars = values.map(([vx, vy], i) => {
           const height = Math.min((vy / yMax) * 100, 100) || 0,
                 start = ((vx-xMin) / (xMax-xMin)) * 95,
                 end = values[i+1] ? (values[i+1][0]-xMin) / (xMax-xMin) * 95 : 100;
           return {
             width: end-start,
             height,
             x: start,
             y: 100-height,
           };
         });
       }
     })
    </script>
  </head>

  <body x-dev>
    <script type="module">
     window.props = (async () => {
       const showHistory = await fetch("https://niklasfasching.github.io/freiluftkino/showHistory.json").then(r => r.json());
       for (let id in showHistory) {
         const values = showHistory[id]
           .map(([timestamp, available, reserved]) => [timestamp, available])
           .filter(([timestamp, available]) => available != null);
         showHistory[id] = {
           xMin: values[0]?.[0] || 0,
           xMax: Date.now() / 1000,
           yMin: 0,
           yMax: Math.max(...values.map(([x, y]) => y)),
           values,
         };
       }
       return {showHistory};
     })()
    </script>
    <style>
     x-chart svg {
       width: 50em;
       height: 10em;
     }
    </style>
    <script type="text/x-mount">
      <div .for="[url, history] in $.props.showHistory">
        <div>{url}</div>
        <x-chart {...history}></x-chart>
      </div>
    </script>
  </body>
</html>
