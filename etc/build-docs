#!/usr/bin/env bash
set -euo pipefail

rm -rf docs
mkdir docs
cp -r src modules docs/

# github actions sets CI to true
# We only need to set the base_path to xminus when built for production
base_path="/"
: "${CI:=false}"
if [ "${CI}" = true ]; then
    base_path="/xminus/"
fi

body=""

for dir in $(ls -d examples/*/); do
    name="$(basename $dir)"
    index="${name}/index.html"
    echo $dir $base_path $index
    cp -r $dir "docs/${name}"
    (cd docs && ../cli/xminus -bp "$base_path" -b "$index" "$index")
    body="${body}
      <a href='${name}/'><h1>${name}</h1></a>
      <iframe src='${name}/'></iframe>"
done

tee docs/index.html <<EOF
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/src/base.css" rel="stylesheet"/>
    <style>
    html, body {
      height: 100%;
    }
    h1 {
      font-size: 3em;
      margin-top: 1em;
    }
    iframe {
      display: block;
      margin: 0 auto;
      width: 80%;
      height: 100%;
    }
    </style>
  </head>
  <body>
  ${body}
  </body>
</html>
EOF
