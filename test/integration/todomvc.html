<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script type="text/x-template" id="x-todomvc">
      <section class="todoapp">
        <header class="header">
          <h1>todos</h1>
          <input class="new-todo" placeholder="What needs to be done?" autofocus .on:keydown="$.onInput(event)"/>
        </header>
        <section class="main" .if="$.store.items.length">
          <input id="toggle-all" class="toggle-all" type="checkbox"
                 .on:click="$.toggleAll(event)" checked="{!$.store.remaining.length}">
		  <label for="toggle-all">Mark all as complete</label>
          <ul class="todo-list">
            <x-todo-item .for="item in $.store.items"/>
          </ul>

          <footer class="footer" .if="$.store.items.length">
            <span class="todo-count">{$.store.items.length}</span>
            <ul class="filters">
			  <li><a href="#/" class="selected">All</a></li>
			  <li><a href="#/active">Active</a></li>
			  <li><a href="#/completed">Completed</a></li>
		    </ul>
            <button class="clear-completed"
                    .if="$.store.remaining.length < $.store.items.length"
                    .on:click="$.store.clearCompleted()">Clear completed</button>
          </footer>
        </section>

        <footer class="info">
		  <p>Double-click to edit a todo</p>
		  <p>Adapted from <a href="http://todomvc.com">TodoMVC</a></p>
		</footer>
      </section>

    </script>

    <script type="text/x-template" id="x-todo-item">
      <li class="todo-item {$.item.completed ? 'completed' : ''}">
        <input class="toggle" type="checkbox"
               checked="{$.item.completed}"
               .on:click="$.item.completed = !$.item.completed">
        <label .on:dblclick="$.item.editing = true"
               .if="!$.item.editing">{$.item.title}</label>
        <input .if="$.item.editing" class="edit"
               .bind:value="$.item.title"
               .on:blur="$.onEditInput(event, $.item)"
               .on:keydown="$.onEditInput(event, $.item)"
               .on:update="if ($.item.editing) target.focus()">
        <button class="destroy" .on:click="$.store.remove($.item)"></button>
      </li>
    </script>

    <script type="x-module">
     const todomvc = {
       create($) {
         $.store.items = JSON.parse(localStorage.getItem("items") || "[]");
       },
       update($) {
         localStorage.setItem("items", JSON.stringify($.store.items));
       }
     }

    </script>
    <script type="module">

     import {mount} from "/src/runtime.mjs";


     class Store {
       id = 0
       items = []

       add(title) {
         this.items.push({id: this.id++, title, completed: false});
       }

       remove(item) {
         this.items = this.items.filter(_ => _ !== item);
       }

       toggleCompleted(item) {
         item.completed = !item.completed;
       }

       clearCompleted() {
         this.items = this.items.filter(_ => !_.completed);
       }

       get remaining() {
         return this.items.filter(_ => !_.completed);
       }
     }

     window.store = new Store();

     mount(document.body, "x-todomvc", {
       store,
       onInput({target, key}) {
         if (key !== "Enter") return
         this.store.add(target.value.trim());
         target.value = "";
       },

       onEditInput({type, target, key}, item) {
         if (key === 'Escape') {
           item.editing = false;
         } else if (key === "Enter" || type === "blur") {
           item.title = target.value.trim();
           item.editing = false;
           if (!item.title) this.store.remove(item);
         }
       },

       toggleAll({target}) {
         for (const item of this.store.items) item.completed = target.checked;
       }
     });
    </script>
  </head>
  <body></body>
</html>
